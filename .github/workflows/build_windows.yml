name: Build and Release Windows
permissions:
  contents: write

on:
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    env:
      GOOS: windows
      GOARCH: amd64
      CGO_ENABLED: "1"

    steps:
      # ---------------------------------------------------------
      # Checkout repository
      # ---------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------------------------------------
      # Compute semantic version + create tag (UNCHANGED)
      # ---------------------------------------------------------
      - name: Compute semantic version
        id: semver
        run: |
          set -euo pipefail

          declare -i major=0
          declare -i minor=0
          declare -i patch=0
          declare -a commits

          IFS=$'\n' read -r -d '' -a commits < <(git log --pretty="%s" | tac && printf '\0')

          for line in "${commits[@]}"; do
              if [[ $line == fix:* ]]; then
                  fixes=$(grep -o "fix:" <<< "$line" | wc -l)
                  ((patch += fixes))
              fi

              if [[ $line == feat:* ]]; then
                  features=$(grep -o "feat:" <<< "$line" | wc -l)
                  ((minor += features))
                  patch=0
              fi

              if [[ $line == *"!:"* ]] || [[ $line == *"BREAKING CHANGE:"* ]]; then
                  ((major++))
                  minor=0
                  patch=0
              fi
          done

          VERSION="v${major}.${minor}.${patch}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          echo "Computed version: $VERSION"

          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Tag $VERSION already exists. Skipping tag creation."
          else
            git tag "$VERSION"
            git push origin "$VERSION"
            echo "Created and pushed tag $VERSION"
          fi

      # ---------------------------------------------------------
      # Install dependencies
      # ---------------------------------------------------------
      - name: Install MinGW + tools
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64 pkg-config zip

      # ---------------------------------------------------------
      # Validate raylib artifacts
      # ---------------------------------------------------------
      - name: Verify raylib artifacts
        run: |
          ls -la raylib || (echo "raylib directory missing" && exit 1)
          ls -la raylib/lib || (echo "raylib/lib missing" && exit 1)
          test -f raylib/lib/libraylibdll.a || (echo "Missing MinGW import lib" && exit 1)

      # ---------------------------------------------------------
      # Build Windows binary
      # ---------------------------------------------------------
      - name: Set binary name
        run: |
          BINARY_NAME="${GITHUB_REPOSITORY##*/}-$GOOS-$GOARCH"
          echo "BINARY_NAME=$BINARY_NAME" >> $GITHUB_ENV

      - name: Build Go executable
        env:
          CC: x86_64-w64-mingw32-gcc
          CGO_CFLAGS: "-I${{ github.workspace }}/raylib/include"
          CGO_LDFLAGS: "-L${{ github.workspace }}/raylib/lib -lraylib"
        run: |
          mkdir -p dist
          go build -v -o dist/${BINARY_NAME}.exe .

      - name: Copy raylib.dll
        run: cp raylib/lib/raylib.dll dist/

      - name: Copy assets
        run: |
          if [ -d assets ]; then
            cp -r assets dist/
            echo "Assets copied"
          else
            echo "No assets directory found"
          fi

      # ---------------------------------------------------------
      # Package ZIP
      # ---------------------------------------------------------
      - name: Package ZIP
        run: |
          cd dist
          zip -r ${BINARY_NAME}.zip ./*

      # ---------------------------------------------------------
      # Create GitHub Release + Upload Asset
      # ---------------------------------------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: Release ${{ env.VERSION }}
          draft: false
          prerelease: false
          files: dist/${{ env.BINARY_NAME }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
