name: Build and Release Windows

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: ubuntu-latest
    env:
      GOOS: windows
      GOARCH: amd64
      CGO_ENABLED: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y mingw-w64 pkg-config zip

      - name: Verify raylib artifacts in raylib/lib
        run: |
          echo "Listing raylib directory:"
          ls -la raylib || (echo "raylib directory not found; ensure raylib/include and raylib/lib exist" && exit 1)
          ls -la raylib/lib || (echo "raylib/lib not found; ensure import lib and raylib.dll are present" && exit 1)
          echo "Expecting: raylib/include, raylib/lib/libraylibdll.a (or raylib.lib), raylib/lib/raylib.dll"

      - name: Detect import library type
        id: detect_import
        run: |
          if [ -f raylib/lib/libraylibdll.a ]; then
            echo "IMPORT_LIB_TYPE=mingw" >> $GITHUB_ENV
          elif [ -f raylib/lib/raylib.lib ]; then
            echo "IMPORT_LIB_TYPE=msvc" >> $GITHUB_ENV
          else
            echo "No import library found. Place libraylibdll.a (MinGW) or raylib.lib (MSVC) in raylib/lib"
            exit 1
          fi
          echo "IMPORT_LIB_TYPE set to $IMPORT_LIB_TYPE"

      - name: Fail if only MSVC import lib present
        if: env.IMPORT_LIB_TYPE == 'msvc'
        run: |
          echo "Found raylib/lib/raylib.lib (MSVC import lib). This job uses MinGW on ubuntu-latest and requires libraylibdll.a."
          echo "Either add a MinGW import lib (libraylibdll.a) to raylib/lib or run the build on a Windows runner with MSVC."
          exit 1

      - name: Set binary name
        run: |
          BINARY_NAME="${GITHUB_REPOSITORY}-$GOOS-$GOARCH"
          echo "BINARY_NAME=$BINARY_NAME" >> $GITHUB_ENV

      - name: Build Go exe for Windows (link to existing import lib)
        if: env.IMPORT_LIB_TYPE == 'mingw'
        env:
          CC: x86_64-w64-mingw32-gcc
          CGO_CFLAGS: "-I${{ github.workspace }}/raylib/include"
          CGO_LDFLAGS: "-L${{ github.workspace }}/raylib/lib -lraylib"
        run: |
          set -e
          echo "Using BINARY_NAME=${BINARY_NAME}"
          mkdir -p dist
          # main.go is at repo root; build package from root
          go build -v -o dist/${BINARY_NAME}.exe .

      - name: Copy raylib.dll next to exe
        if: env.IMPORT_LIB_TYPE == 'mingw'
        run: |
          cp raylib/lib/raylib.dll dist/ || (echo "raylib.dll not found in raylib/lib" && exit 1)
          ls -la dist

      - name: Package ZIP (exe + dll)
        if: env.IMPORT_LIB_TYPE == 'mingw'
        run: |
          cd dist
          zip -r ../${BINARY_NAME}.zip ./*
          cd ..
          ls -la ${BINARY_NAME}.zip

      - name: Create GitHub Release
        if: env.IMPORT_LIB_TYPE == 'mingw'
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release asset (zip)
        if: env.IMPORT_LIB_TYPE == 'mingw'
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.BINARY_NAME }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
