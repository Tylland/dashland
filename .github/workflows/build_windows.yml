name: Build and Release Windows
permissions:
  contents: write

on:
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    env:
      GOOS: windows
      GOARCH: amd64
      CGO_ENABLED: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------------------------------------
      # Compute semantic version + changelog
      # ---------------------------------------------------------
      - name: Compute semantic version + changelog
        id: versioning
        run: |
          set -euo pipefail
          
          # Get latest tag (if none, default to v0.0.0)
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Last tag: $LAST_TAG"
          
          # Get commits since last tag
          COMMITS=$(git log ${LAST_TAG}..HEAD --pretty="%s")
          
          # Init counters
          major=0; minor=0; patch=0
          
          while IFS= read -r line; do
            [[ $line == fix:* ]] && ((patch++))
            [[ $line == feat:* ]] && { ((minor++)); patch=0; }
            [[ $line == *"!:"* || $line == *"BREAKING CHANGE:"* ]] && { ((major++)); minor=0; patch=0; }
          done <<< "$COMMITS"
          
          # Extract previous version numbers
          IFS='.' read -r old_major old_minor old_patch <<< "${LAST_TAG#v}"
          
          # Apply increments
          new_major=$((old_major + major))
          new_minor=$((major > 0 ? 0 : old_minor + minor))
          new_patch=$((major > 0 || minor > 0 ? 0 : old_patch + patch))
          
          # Build number = total commit count
          BUILD=$(git rev-list --count HEAD)
          
          VERSION="v${new_major}.${new_minor}.${new_patch}.${BUILD}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          echo "Computed version: $VERSION"
          
          # Skip release if version already exists
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Version $VERSION already exists. No new commits. Skipping release."
            echo "skip_release=true" >> $GITHUB_ENV
            exit 0
          fi
          
          # Generate changelog
          echo "Changelog since $LAST_TAG:" > CHANGELOG.md
          git log ${LAST_TAG}..HEAD --pretty="- %s" >> CHANGELOG.md


      # ---------------------------------------------------------
      # Build Windows binary
      # ---------------------------------------------------------
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y mingw-w64 pkg-config zip

      - name: Verify raylib artifacts
        run: |
          ls -la raylib || (echo "raylib directory missing" && exit 1)
          ls -la raylib/lib || (echo "raylib/lib missing" && exit 1)

      - name: Detect import library type
        run: |
          if [ -f raylib/lib/libraylibdll.a ]; then
            echo "IMPORT_LIB_TYPE=mingw" >> $GITHUB_ENV
          else
            echo "Missing MinGW import lib (libraylibdll.a)"
            exit 1
          fi

      - name: Set binary name
        run: |
          BINARY_NAME="${GITHUB_REPOSITORY##*/}-$GOOS-$GOARCH"
          echo "BINARY_NAME=$BINARY_NAME" >> $GITHUB_ENV

      - name: Build Go exe for Windows
        env:
          CC: x86_64-w64-mingw32-gcc
          CGO_CFLAGS: "-I${{ github.workspace }}/raylib/include"
          CGO_LDFLAGS: "-L${{ github.workspace }}/raylib/lib -lraylib"
        run: |
          mkdir -p dist
          go build -v -o dist/${BINARY_NAME}.exe .

      - name: Copy raylib.dll
        run: cp raylib/lib/raylib.dll dist/

      - name: Copy asset directory
        run: |
          if [ -d assets ]; then
            cp -r assets dist/
          fi

      - name: Package ZIP
        run: |
          cd dist
          zip -r ${BINARY_NAME}.zip ./*

      # ---------------------------------------------------------
      # Create GitHub Release + upload assets
      # ---------------------------------------------------------
      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: Release ${{ env.VERSION }}
          body_path: CHANGELOG.md
          files: dist/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
